"""This is the visualization code to create vtu, pvtu, pvd files for Voronoid Model Grid

check the io.py file for the functions used: vtu_dump, pvtu_dump, create_pvd

references:
Eric's io.py files
https://github.com/mcflugen/landlab-parallel/blob/main/src/landlab_parallel/io.py

landlab legacy_vtk
https://landlab.readthedocs.io/en/latest/generated/api/landlab.io.legacy_vtk.html
"""

from visualization.io import vtu_dump, pvtu_dump, create_pvd
from landlab import VoronoiDelaunayGrid
import matplotlib.pyplot as plt
import numpy as np
import os

# output dir
output_dir = os.path.join(os.getcwd(),'visualization/pvtu_vtu')
os.makedirs(output_dir, exist_ok=True)

# model grid x and y
rank_0 = {
    "x": [10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 9.5, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 9.5, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 12.0, 13.0, 14.0, 15.0, 16.0, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 12.0, 13.0, 14.0, 15.0, 16.0, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0],
    "y": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406],
}

rank_1 = {
    "x": [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0],
    "y": [6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 8.660254, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 9.526279, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 10.392305, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 11.25833, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.124356, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 12.990381, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406, 13.856406]
}

rank_2 = {
    "x":[0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5],
    "y": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 0.866025, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 1.732051, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 2.598076, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 3.464102, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 4.330127, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 5.196152, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.062178, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 6.928203, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229, 7.794229]
}

i = 0
for rank in [rank_0, rank_1,rank_2]:
    # define model and plot
    vmg = VoronoiDelaunayGrid(rank["x"], rank["y"])
    elev = np.arange(vmg.number_of_nodes)
    vmg.add_field("topographic_elevation", elev)

    # create plot for 3 time steps
    for step in range(1,4):
        vmg.at_node["topographic_elevation"] = elev * step

        plt.clf()
        vmg.imshow("topographic_elevation")
        plt.savefig(os.path.join(output_dir, f"rank{i}_{step}_elev.png"))
        plt.close()

        # create vtu file for each rank
        with open(os.path.join(output_dir, f"rank{i}_{step}.vtu"), "w") as fp:
            fp.write(vtu_dump(vmg))

    i+=1

# create pvtu files for each time step
pvtu_files = []
for step in range(1,4):
    with open(os.path.join(output_dir, f"global_{step}.pvtu"), "w") as fp:
        fp.write(pvtu_dump(vmg, [f"rank{rank}_{step}.vtu" for rank in range(0,3)]))
    pvtu_files.append(f"global_{step}.pvtu")


# create pvd files for all time steps
timesteps = list(range(1,4))
pvd_file_path = os.path.join(output_dir, "simulation.pvd")
create_pvd(pvtu_files, timesteps, pvd_file_path)